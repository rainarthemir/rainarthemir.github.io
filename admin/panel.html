<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ê–¥–º–∏–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤</title>
<link rel="stylesheet" href="style.css">
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: background 0.3s, color 0.3s;
}
h1 { margin-bottom: 20px; }
#controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
#project-form { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
#project-form input { padding: 8px; font-size: 16px; }
#buttons { display: flex; flex-direction: column; gap: 10px; width: 500px; }
.project-item { display: flex; align-items: center; justify-content: space-between; padding: 5px; border-radius: 6px; transition: background 0.3s; }
.project-info { display: flex; gap: 10px; align-items: center; }
.project-name { padding: 6px 10px; border-radius: 6px; color: white; }
button { padding: 5px 10px; cursor: pointer; border-radius: 5px; border: none; background: #0078d4; color: white; transition: 0.2s; }
button:hover { background: #005a9e; }
#logoutBtn { background: #d9534f; }
#logoutBtn:hover { background: #b52b2b; }
.dark { background: #1e1e1e; color: #f0f0f0; }
.dark .project-item { background: #2c2c2c; }
.dark button { background: #4444aa; color: #fff; }
.dark button:hover { background: #222288; }
</style>
</head>
<body>

<h1>–ê–¥–º–∏–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤</h1>

<div id="controls">
  <button id="logoutBtn">–í—ã–π—Ç–∏</button>
  <button id="themeBtn">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
</div>

<div id="project-form">
  <input type="text" id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞">
  <input type="url" id="link" placeholder="–°—Å—ã–ª–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞">
  <input type="color" id="color" value="#0078d4">
  <button id="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
</div>

<div id="buttons"></div>

<script>
const API_URL = "https://projects.dmytrothemir.workers.dev/";

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
const TOKEN = localStorage.getItem("authToken");
const loggedIn = localStorage.getItem("loggedIn");
if (!TOKEN || loggedIn !== "true") {
  window.location.href = "login.html";
}

// Logout
document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("authToken");
  localStorage.removeItem("loggedIn");
  window.location.href = "login.html";
};

// –¢–µ–º–∞
const themeBtn = document.getElementById("themeBtn");
let darkMode = localStorage.getItem("theme") === "dark";
setTheme(darkMode);

themeBtn.onclick = () => {
  darkMode = !darkMode;
  setTheme(darkMode);
  localStorage.setItem("theme", darkMode ? "dark" : "light");
};

function setTheme(isDark) {
  if (isDark) {
    document.body.classList.add("dark");
    themeBtn.textContent = "‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞";
  } else {
    document.body.classList.remove("dark");
    themeBtn.textContent = "üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞";
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
async function loadProjects() {
  const container = document.getElementById("buttons");
  container.innerHTML = "";
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤");

    data.projects.forEach(p => {
      const div = document.createElement("div");
      div.className = "project-item";

      const info = document.createElement("div");
      info.className = "project-info";

      const span = document.createElement("span");
      span.textContent = p.name;
      span.className = "project-name";
      span.style.backgroundColor = p.color;

      const link = document.createElement("a");
      link.href = p.link || "#";
      link.textContent = "–°—Å—ã–ª–∫–∞";
      link.target = "_blank";

      info.appendChild(span);
      info.appendChild(link);

      const editBtn = document.createElement("button");
      editBtn.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
      editBtn.onclick = () => editProject(p.name, p.color, p.link);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
      deleteBtn.onclick = () => deleteProject(p.name);

      div.appendChild(info);
      div.appendChild(editBtn);
      div.appendChild(deleteBtn);
      container.appendChild(div);
    });

  } catch (err) {
    container.innerHTML = "–û—à–∏–±–∫–∞: " + err.message;
  }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
async function addProject() {
  const token = localStorage.getItem("authToken");
  if (!token) return alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã");

  const name = document.getElementById("name").value.trim();
  const color = document.getElementById("color").value;
  const link = document.getElementById("link").value.trim();

  if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");

  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": token },
    body: JSON.stringify({ name, color, link })
  });

  const result = await res.json();
  if (result.success) {
    document.getElementById("name").value = "";
    document.getElementById("link").value = "";
    loadProjects();
  } else alert(result.error);
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
async function editProject(oldName, oldColor, oldLink) {
  const token = localStorage.getItem("authToken");
  if (!token) return alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã");

  const name = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:", oldName);
  if (!name) return;
  const color = prompt("–ù–æ–≤—ã–π —Ü–≤–µ—Ç (hex):", oldColor);
  if (!color) return;
  const link = prompt("–ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞:", oldLink || "");
  if (link === null) return;

  const res = await fetch(API_URL, {
    method: "PUT",
    headers: { "Content-Type": "application/json", "Authorization": token },
    body: JSON.stringify({ oldName, name, color, link })
  });

  const result = await res.json();
  if (result.success) loadProjects();
  else alert(result.error);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
async function deleteProject(name) {
  const token = localStorage.getItem("authToken");
  if (!token) return alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã");
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç "${name}"?`)) return;

  const res = await fetch(API_URL, {
    method: "DELETE",
    headers: { "Content-Type": "application/json", "Authorization": token },
    body: JSON.stringify({ name })
  });

  const result = await res.json();
  if (result.success) loadProjects();
  else alert(result.error);
}

// –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–∏—Ç—å
document.getElementById("addBtn").addEventListener("click", addProject);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
loadProjects();
</script>

</body>
</html>
